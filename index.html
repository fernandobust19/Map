<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ruta hacia Sucursales UPCONS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #map { height: 100%; width: 100%; }
    /* Bot贸n flotante centrado abajo */
    .nav-fab { position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px; z-index: 20; }
    /* Corrige z-index del autocompletado */
    .pac-container { z-index: 50 !important; }
    /* Estilo para botones de sucursal activos */
    .sucursal-btn.active { 
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); 
      transform: scale(1.02);
      transition: all 0.2s ease;
    }
  </style>

  <script>
    // ===== TU CLAVE GOOGLE MAPS =====
    const GOOGLE_MAPS_API_KEY = "AIzaSyDNbUt1C8PHlkLkcGZlCdfNqtm7n-SvX_E"; // <-- Modo desarrollo (muestra marca de agua pero funciona)
    // ===== SUCURSALES UPCONS =====
    const SUCURSALES = {
      mariscal: {
        nombre: "Sucursal: Mariscal Sucre y Arturo Tipanguano",
        direccion: "UPCONS, Av. Mariscal Sucre y Arturo Tipanguano, Quito, Ecuador"
      },
      ecuatoriana: {
        nombre: "Sucursal: La Ecuatoriana y Martin Icaza", 
        direccion: "La Ecuatoriana y Martin Icaza, Quito, Ecuador",
        coordenadas: { lat: -0.3071724, lng: -78.559899 }
      }
    };
    // ================================

    // Carga Maps + Places
    (function loadGoogleMaps() {
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_MAPS_API_KEY)}&libraries=places&callback=initMap`;
      s.async = true; s.defer = true;
      document.head.appendChild(s);
    })();
  </script>
</head>
<body class="bg-gray-100">
  <div id="map"></div>

  <!-- Panel compacto y transl煤cido -->
  <div id="panel" class="absolute top-3 left-1/2 -translate-x-1/2 z-10 w-[92%] max-w-md">
    <div class="rounded-2xl shadow-2xl backdrop-blur bg-blue-900/55 border border-white/10 px-3 py-2">
      <div class="flex items-center justify-between">
        <h1 class="text-white text-base font-semibold tracking-wide">Ir a <span class="text-emerald-200">UPCONS</span></h1>
        <button id="centerButton" class="text-white/90 text-xs px-2 py-1 rounded-md hover:bg-white/10">Ver Sucursal</button>
      </div>

      <!-- Campo de origen -->
      <div class="mt-2 grid grid-cols-12 gap-2">
        <div class="col-span-7">
          <input id="start" type="text" placeholder="Su origen (direcci贸n o lugar)"
            class="w-full text-sm px-3 py-2 rounded-lg bg-white/90 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 placeholder-gray-500"/>
        </div>
        <div class="col-span-5 flex">
          <button id="useLocationBtn" title="Usar mi ubicaci贸n"
            class="flex-1 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium px-2">
             Mi ubicaci贸n
          </button>
        </div>
      </div>

      <div class="mt-2">
        <p class="text-[11px] text-emerald-100 mb-2">Seleccione la sucursal de destino:</p>
        <div class="grid grid-cols-1 gap-2">
          <button id="btnMariscal" 
            class="sucursal-btn active w-full text-sm px-3 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white font-medium border-2 border-indigo-300">
            Sucursal: Mariscal Sucre y Arturo Tipanguano
          </button>
          <button id="btnEcuatoriana" 
            class="sucursal-btn w-full text-sm px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white font-medium border-2 border-white/30">
            Sucursal: La Ecuatoriana y Martin Icaza
          </button>
        </div>
        <p id="destinoLabel" class="text-[11px] text-emerald-100 mt-2 line-clamp-2"></p>
      </div>

      <div class="mt-2 flex gap-1">
        <button id="drawRouteButton"
          class="flex-1 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold py-2">
          Dibujar ruta
        </button>
      </div>

      <p id="status" class="mt-2 text-[12px] text-emerald-100/90">
        Ingrese su origen o use <b>Usar mi ubicaci贸n</b> para trazar la ruta.
      </p>
      <p id="httpsHint" class="hidden mt-2 text-[11px] text-amber-200">
        S铆rvalo con <b>HTTPS</b> (o <code>localhost</code>) y permita la ubicaci贸n para GPS.
      </p>
    </div>
  </div>

  <!-- Bot贸n flotante de navegaci贸n (solo aparece despu茅s de trazar) -->
  <div class="nav-fab">
    <button id="navigateButton" disabled
      class="hidden rounded-full shadow-2xl px-5 py-3 text-white font-bold text-sm bg-green-600 hover:bg-green-700">
      Comenzar a navegar
    </button>
  </div>

  <script>
    let map, directionsService, directionsRenderer, geocoder;
    let guidePolyline, animatedPolyline, startMarker, endMarker, autocompleteStart;

    const startInput = document.getElementById('start');
    const btnMariscal = document.getElementById('btnMariscal');
    const btnEcuatoriana = document.getElementById('btnEcuatoriana');
    const statusEl   = document.getElementById('status');
    const drawBtn    = document.getElementById('drawRouteButton');
    const gpsBtn     = document.getElementById('useLocationBtn');
    const centerBtn  = document.getElementById('centerButton');
    const panel      = document.getElementById('panel');
    const navBtn     = document.getElementById('navigateButton');
    const httpsHint  = document.getElementById('httpsHint');

    let sucursalSeleccionada = 'mariscal'; // Por defecto Mariscal Sucre

    let lastOriginForNav = null; // "Current+Location" o direcci贸n encodeada
    let lastDestForNav   = null; // "lat,lng" o texto encodeado

    // Callback global
    window.initMap = function () {
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        httpsHint.classList.remove('hidden');
      }

      updateDestinoLabel();

      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: { lat: -0.22985, lng: -78.52495 }, // Quito aprox.
        mapTypeId: 'roadmap',
        zoomControl: true,
        streetViewControl: false,
        mapTypeControl: false,
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map,
        suppressPolylines: true,
        suppressMarkers: true
      });
      geocoder = new google.maps.Geocoder();

      // Autocompletado compacto
      autocompleteStart = new google.maps.places.Autocomplete(startInput, {
        // componentRestrictions: { country: ["ec"] } // opcional
      });
      // Si el usuario escribe despu茅s de usar GPS, borramos el marcador de GPS para evitar conflictos.
      autocompleteStart.addListener('place_changed', () => {
        if (startMarker) { startMarker.setMap(null); startMarker = null; }
      });


      // Geocodificar sucursal inicial (Mariscal Sucre)
      updateSucursalMarker();
      
      // Eventos para botones de sucursales
      btnMariscal.addEventListener('click', () => selectSucursal('mariscal'));
      btnEcuatoriana.addEventListener('click', () => selectSucursal('ecuatoriana'));

      // Eventos
      drawBtn.addEventListener('click', calculateAndDisplayRoute);
      gpsBtn.addEventListener('click', setStartToCurrentUserLocation);
      centerBtn.addEventListener('click', () => {
        if (endMarker) {
          map.panTo(endMarker.getPosition());
          map.setZoom(15);
        }
      });
      navBtn.addEventListener('click', openTurnByTurn);
    };

    // GPS como origen
    function setStartToCurrentUserLocation() {
      if (!('geolocation' in navigator)) {
        statusEl.textContent = "Su navegador no soporta geolocalizaci贸n.";
        return;
      }
      statusEl.textContent = "Obteniendo su ubicaci贸n...";
      const opts = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };

      navigator.geolocation.getCurrentPosition(
        pos => {
          const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };

          if (startMarker) startMarker.setMap(null);
          startMarker = new google.maps.Marker({
            map, position: latlng, title: "Mi ubicaci贸n",
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6,
                    fillColor: "#10B981", fillOpacity: 1, strokeColor: "#065F46", strokeWeight: 1 }
          });
          map.panTo(latlng);
          map.setZoom(14);

          geocoder.geocode({ location: latlng }, (results, status) => {
            if (status === "OK" && results[0]) {
              startInput.value = results[0].formatted_address;
              statusEl.textContent = "Ubicaci贸n encontrada. Presione 'Dibujar ruta'.";
            } else {
              startInput.value = "Ubicaci贸n actual (aproximada)"; // Texto alternativo si no hay direcci贸n
              statusEl.textContent = "Ubicaci贸n lista. Presione 'Dibujar ruta'.";
            }
          });
        },
        err => {
          if (err.code === err.PERMISSION_DENIED) {
            statusEl.textContent = "Permiso de ubicaci贸n denegado. Revise los ajustes de su navegador para este sitio.";
          } else if (err.code === err.POSITION_UNAVAILABLE) {
            statusEl.textContent = "Ubicaci贸n no disponible. Revise GPS o se帽al.";
          } else if (err.code === err.TIMEOUT) {
            statusEl.textContent = "Tiempo de espera agotado. Intente nuevamente.";
          } else {
            statusEl.textContent = "No se pudo obtener su ubicaci贸n.";
          }
        },
        opts
      );
    }

    // Dibujar ruta y luego ocultar panel
    function calculateAndDisplayRoute() {
      const startVal = startInput.value.trim();
      const hasOrigin = startVal.length > 0;

      // Si no hay texto de origen Y no hay un marcador de GPS, no hacer nada.
      if (!hasOrigin && !startMarker) {
        alert("Por favor, ingrese una direcci贸n de origen o use el bot贸n de ubicaci贸n.");
        return;
      }
      
      statusEl.textContent = "Calculando ruta...";
      clearRoute();

      // Prioridad: Si hay un marcador de GPS, usarlo. Si no, usar el texto del input.
      const originReq = startMarker 
        ? startMarker.getPosition() 
        : startVal;
      
      const sucursalActual = SUCURSALES[sucursalSeleccionada];
      const destReq = sucursalActual.coordenadas 
        ? new google.maps.LatLng(sucursalActual.coordenadas.lat, sucursalActual.coordenadas.lng)
        : sucursalActual.direccion;

      directionsService.route({
        origin: originReq,
        destination: destReq,
        travelMode: google.maps.TravelMode.DRIVING,
        provideRouteAlternatives: false
      }, (res, status) => {
        if (status !== "OK") {
          let errorMsg = "No se pudo calcular la ruta. ";
          if (status === "REQUEST_DENIED") {
            errorMsg += "Solicitud denegada. Verifique la API Key y la facturaci贸n en Google Cloud.";
          } else if (status === "ZERO_RESULTS") {
            errorMsg += "No se encontr贸 una ruta entre los puntos.";
          } else if (status === "NOT_FOUND") {
            errorMsg += "Una de las ubicaciones no se encontr贸.";
          }
          statusEl.textContent = errorMsg;
          return;
        }

        const route = res.routes[0];
        directionsRenderer.setDirections(res);

        // Marcadores
        const startLoc = route.legs[0].start_location;
        startMarker = new google.maps.Marker({
          map, position: startLoc, title: "Origen",
          icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6,
                  fillColor: "#2563EB", fillOpacity: 1, strokeColor: "#1E3A8A", strokeWeight: 1 }
        });

        // Polil铆nea base
        const path = route.overview_path;
        guidePolyline = new google.maps.Polyline({
          path, strokeColor: "#93C5FD", strokeOpacity: 0.7, strokeWeight: 6, map
        });

        // Polil铆nea animada r谩pida
        animatedPolyline = new google.maps.Polyline({
          map, strokeColor: "#EF4444", strokeOpacity: 0.95, strokeWeight: 6
        });

        let step = 0;
        const stepsPerTick = Math.max(1, Math.floor(path.length / 180));
        const tick = setInterval(() => {
          if (step >= path.length) {
            clearInterval(tick);
            fitAll(startMarker.getPosition(), endMarker?.getPosition(), path);
            // Guardar datos para navegaci贸n
            // Si se us贸 GPS, el origen es la ubicaci贸n actual para la navegaci贸n.
            // Si hay marcador GPS, el origen es "Current+Location", si no, es el texto del input.
            lastOriginForNav = (startMarker && !hasOrigin) ? "Current+Location" : encodeURIComponent(startVal);
            const sucursalParaNav = SUCURSALES[sucursalSeleccionada];
            lastDestForNav = sucursalParaNav.coordenadas 
              ? `${sucursalParaNav.coordenadas.lat},${sucursalParaNav.coordenadas.lng}`
              : encodeURIComponent(sucursalParaNav.direccion);

            // Ocultar panel y mostrar bot贸n de navegaci贸n
            panel.classList.add('hidden');
            navBtn.classList.remove('hidden');
            navBtn.disabled = false;
            return;
          }
          const currentPath = animatedPolyline.getPath();
          for (let i = 0; i < stepsPerTick && step < path.length; i++, step++) {
            currentPath.push(path[step]);
          }
        }, 20);
      });
    }

    function openTurnByTurn() {
      // Detectar si es iOS para usar Apple Maps
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

      const origin = lastOriginForNav || "Current+Location";
      const dest   = lastDestForNav || encodeURIComponent(SUCURSALES[sucursalSeleccionada].direccion);
      let navUrl;

      if (isIOS) {
        // URL para Apple Maps. saddr=start, daddr=destination
        navUrl = `https://maps.apple.com/?saddr=${origin}&daddr=${dest}&dirflg=d`;
      } else {
        // URL para Google Maps en otras plataformas (Android, Web)
        navUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=driving&dir_action=navigate`;
      }
      window.open(navUrl, "_blank");
    }

    function fitAll(startPos, endPos, path) {
      const bounds = new google.maps.LatLngBounds();
      if (startPos) bounds.extend(startPos);
      if (endPos) bounds.extend(endPos);
      if (Array.isArray(path)) path.forEach(p => bounds.extend(p));
      map.fitBounds(bounds);
    }

    function clearRoute() {
      if (guidePolyline) { guidePolyline.setMap(null); guidePolyline = null; }
      if (animatedPolyline) { animatedPolyline.setMap(null); animatedPolyline = null; }
      // NO eliminamos startMarker aqu铆 para preservar la ubicaci贸n GPS
      // endMarker se queda (sucursal seleccionada)
      navBtn.classList.add('hidden');
      navBtn.disabled = true;
    }

    function selectSucursal(tipo) {
      sucursalSeleccionada = tipo;
      
      // Actualizar estilos de botones
      document.querySelectorAll('.sucursal-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-500', 'hover:bg-indigo-600', 'border-indigo-300');
        btn.classList.add('bg-white/20', 'hover:bg-white/30', 'border-white/30');
      });
      
      const btnActivo = tipo === 'mariscal' ? btnMariscal : btnEcuatoriana;
      btnActivo.classList.remove('bg-white/20', 'hover:bg-white/30', 'border-white/30');
      btnActivo.classList.add('active', 'bg-indigo-500', 'hover:bg-indigo-600', 'border-indigo-300');
      
      updateSucursalMarker();
    }

    function updateDestinoLabel() {
      const sucursal = SUCURSALES[sucursalSeleccionada];
      document.getElementById('destinoLabel').textContent = `Destino: ${sucursal.direccion}`;
    }

    function updateSucursalMarker() {
      const sucursal = SUCURSALES[sucursalSeleccionada];
      
      // Eliminar marcador anterior si existe
      if (endMarker) {
        endMarker.setMap(null);
      }
      
      if (sucursal.coordenadas) {
        // Usar coordenadas directas para La Ecuatoriana
        const destLocation = new google.maps.LatLng(sucursal.coordenadas.lat, sucursal.coordenadas.lng);
        endMarker = new google.maps.Marker({
          map, 
          position: destLocation, 
          title: sucursal.nombre,
          icon: { 
            path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, 
            scale: 6,
            fillColor: "#60A5FA", 
            fillOpacity: 1, 
            strokeColor: "#1E3A8A", 
            strokeWeight: 1 
          }
        });
        updateDestinoLabel();
      } else {
        // Geocodificar para Mariscal Sucre
        geocoder.geocode({ address: sucursal.direccion }, (results, status) => {
          if (status === "OK" && results[0]) {
            const destLocation = results[0].geometry.location;
            endMarker = new google.maps.Marker({
              map, 
              position: destLocation, 
              title: sucursal.nombre,
              icon: { 
                path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, 
                scale: 6,
                fillColor: "#60A5FA", 
                fillOpacity: 1, 
                strokeColor: "#1E3A8A", 
                strokeWeight: 1 
              }
            });
            updateDestinoLabel();
          } else {
            statusEl.textContent = `No se pudo fijar el destino ${sucursal.nombre}. Revise la direcci贸n.`;
          }
        });
      }
    }
  </script>
</body>
</html>
